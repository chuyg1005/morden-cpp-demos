name: Weather Notification for Shanghai and Hangzhou

on:
  schedule:
    # Run every minute
    - cron: '* * * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  send-weather-email:
    runs-on: ubuntu-latest
    steps:
      - name: Get weather data
        id: weather
        run: |
          # Using wttr.in API to get weather information
          # Note: wttr.in has rate limits, so this might not work for every minute in practice
          shanghai_weather=$(curl -s "https://wttr.in/Shanghai?format=3" 2>/dev/null || echo "无法获取上海天气信息")
          hangzhou_weather=$(curl -s "https://wttr.in/Hangzhou?format=3" 2>/dev/null || echo "无法获取杭州天气信息")
          
          # Format the message
          message="上海天气: $shanghai_weather\n杭州天气: $hangzhou_weather\n\n信息获取时间: $(date)"
          
          # Save to environment file for use in next step
          echo "message<<EOF" >> $GITHUB_ENV
          echo "$message" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "上海杭州天气信息 - $(date +%Y-%m-%d\ %H:%M)"
          body: |
            ${{ env.message }}
            
            ---
            此邮件由GitHub Actions自动发送
            发送时间: ${{ github.event.schedule }} 或手动触发
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: GitHub Actions Weather Bot